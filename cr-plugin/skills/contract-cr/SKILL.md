---
name: contract-cr
description: 签约项目代码审查规范，涵盖签约业务逻辑、数据安全、合规性等关键检查项
---

# 签约项目代码审查规范

## 一、签约业务逻辑审查

### 1.1 签约流程完整性
- ✅ 签约状态流转是否完整（草稿 → 待审核 → 审核中 → 已签约 → 已归档）
- ✅ 状态变更是否有日志记录和审计追踪
- ✅ 异常状态处理是否完善（签约失败、超时、取消等）
- ✅ 是否有状态回滚机制

### 1.2 签约数据校验
- ✅ 合同金额是否进行格式和范围校验
- ✅ 签约日期是否校验（不能早于当前日期）
- ✅ 合同编号是否唯一性检查
- ✅ 必填字段是否完整验证（甲方、乙方、合同类型、金额等）
- ✅ 附件上传是否有大小和格式限制

### 1.3 业务规则检查
- ✅ 签约权限控制是否完善（角色权限、数据权限）
- ✅ 合同审批流程是否符合业务规则
- ✅ 是否检查客户资质和信用状态
- ✅ 重复签约防护（同一客户同一项目）
- ✅ 合同金额是否符合审批阈值规则

## 二、数据安全审查

### 2.1 敏感信息保护
- ❌ **禁止明文存储**：客户身份证号、银行账号、手机号等敏感信息
- ✅ 敏感数据必须加密存储（AES-256 或以上）
- ✅ 日志中不得打印完整敏感信息（需脱敏处理）
- ✅ 前端展示敏感信息需脱敏（如：138****8888）
- ✅ 敏感字段查询必须有权限控制

### 2.2 数据传输安全
- ✅ 所有签约接口必须使用 HTTPS
- ✅ 敏感数据传输时需加密（不能明文传输）
- ✅ API 接口必须有签名验证机制
- ✅ 防止 CSRF 攻击（使用 Token 验证）

### 2.3 数据完整性
- ✅ 关键操作必须使用数据库事务
- ✅ 签约数据修改必须记录变更历史
- ✅ 删除操作必须使用软删除（保留数据）
- ✅ 数据同步时必须有一致性校验

## 三、接口设计审查

### 3.1 RESTful 规范
- ✅ 接口命名符合 RESTful 规范
  - `POST /api/contracts` - 创建签约
  - `PUT /api/contracts/{id}` - 更新签约
  - `GET /api/contracts/{id}` - 查询签约详情
  - `DELETE /api/contracts/{id}` - 删除签约
- ✅ 使用正确的 HTTP 状态码（200, 201, 400, 401, 403, 404, 500）
- ✅ 响应格式统一（成功/失败格式一致）

### 3.2 接口安全
- ✅ 所有接口必须有身份认证（Token/JWT）
- ✅ 签约相关接口必须有权限校验
- ✅ 接口必须有防重放攻击机制（timestamp + nonce）
- ✅ 接口必须有限流保护（防止恶意调用）
- ✅ 参数必须进行 SQL 注入防护

### 3.3 接口文档
- ✅ 每个签约接口必须有完整的 API 文档
- ✅ 文档包含请求参数、响应格式、错误码说明
- ✅ 关键业务接口必须有调用示例

## 四、前端代码审查

### 4.1 表单验证
- ✅ 所有签约表单字段必须有前端校验
- ✅ 金额输入必须限制格式（保留两位小数）
- ✅ 日期选择器必须有合理的范围限制
- ✅ 文件上传必须校验文件类型和大小
- ✅ 提交前必须二次确认（特别是金额较大的合同）

### 4.2 用户体验
- ✅ 签约流程必须有进度提示（步骤条）
- ✅ 异步操作必须有 Loading 提示
- ✅ 错误信息必须友好且具体
- ✅ 关键操作必须有成功/失败提示
- ✅ 长表单必须支持草稿保存功能

### 4.3 数据展示
- ✅ 合同金额必须格式化显示（千分位分隔）
- ✅ 签约状态必须有明确的视觉标识（颜色、图标）
- ✅ 签约历史记录必须按时间倒序排列
- ✅ 列表页必须支持筛选和搜索功能

## 五、后端代码审查

### 5.1 数据库操作
- ❌ **禁止 N+1 查询问题**：必须使用 JOIN 或预加载
- ✅ 签约主表必须有合理的索引（合同编号、客户ID、状态、创建时间）
- ✅ 批量操作必须控制数量（单次不超过 1000 条）
- ✅ 长时间查询必须优化（添加缓存或异步处理）
- ✅ 事务操作必须有超时控制

### 5.2 异常处理
- ✅ 所有异常必须捕获并记录日志
- ✅ 业务异常必须抛出自定义异常（ContractException）
- ✅ 系统异常必须返回统一的错误信息（不暴露内部细节）
- ✅ 关键操作失败必须有告警机制

### 5.3 日志记录
- ✅ 签约创建/修改/删除必须记录操作日志
- ✅ 日志必须包含：操作人、操作时间、操作内容、IP 地址
- ✅ 敏感信息必须脱敏后记录
- ✅ 异常日志必须包含完整的堆栈信息

## 六、性能优化审查

### 6.1 查询优化
- ✅ 签约列表查询必须支持分页（默认每页 20 条）
- ✅ 复杂查询必须使用缓存（Redis，过期时间 5-10 分钟）
- ✅ 大数据导出必须使用异步任务
- ✅ 避免在循环中查询数据库

### 6.2 并发控制
- ✅ 签约提交必须有防重复提交机制（前端防抖 + 后端幂等）
- ✅ 合同金额修改必须使用乐观锁或悲观锁
- ✅ 库存扣减等操作必须保证原子性

## 七、测试覆盖审查

### 7.1 单元测试
- ✅ 签约核心业务逻辑必须有单元测试
- ✅ 金额计算、状态流转等关键方法必须覆盖
- ✅ 测试用例必须覆盖正常场景和异常场景
- ✅ 测试覆盖率不低于 70%

### 7.2 集成测试
- ✅ 签约完整流程必须有端到端测试
- ✅ 接口必须有集成测试（成功/失败场景）
- ✅ 异常场景必须测试（网络超时、数据库异常等）

## 八、合规性审查

### 8.1 数据留痕
- ✅ 签约操作必须有完整的审计日志
- ✅ 数据修改必须记录修改前后的值
- ✅ 日志保留时间不少于 3 年
- ✅ 关键操作必须支持追溯查询

### 8.2 法律合规
- ✅ 电子签名必须符合《电子签名法》
- ✅ 个人信息处理必须符合《个人信息保护法》
- ✅ 数据跨境传输必须符合相关法规

## 九、代码质量审查

### 9.1 命名规范
- ✅ 签约相关类/方法命名必须清晰（Contract、Sign、Agreement）
- ✅ 布尔变量必须使用 is/has 前缀（isValid、hasPermission）
- ✅ 常量必须使用大写下划线命名（CONTRACT_STATUS_DRAFT）

### 9.2 代码复杂度
- ✅ 单个方法不超过 50 行代码
- ✅ 方法嵌套层级不超过 3 层
- ✅ 复杂业务逻辑必须拆分为多个小方法
- ✅ 避免使用魔法数字（使用常量或枚举）

### 9.3 注释规范
- ✅ 复杂业务逻辑必须添加注释说明
- ✅ 公共方法必须有 JSDoc/JavaDoc 注释
- ✅ 关键算法必须说明实现思路
- ✅ TODO 注释必须标注责任人和时间

## 十、Code Review 输出模板

审查完成后，请按以下格式输出：

---

### 📋 审查概览
- **审查文件**: [文件路径]
- **代码行数**: [行数]
- **审查时间**: [时间]
- **严重程度**: 🔴高危 / 🟡中危 / 🟢低危

---

### ✅ 通过的检查项（符合规范）
1. ✅ 签约状态流转完整，有日志记录
2. ✅ 敏感信息已加密存储
3. ✅ 接口有完整的权限校验
4. ✅ 表单验证完善
...

---

### ⚠️ 需要改进的地方（中等优先级）

#### 1. 缺少防重复提交机制
- **位置**: `src/api/contract.js:45`
- **问题**: 签约提交接口未添加防重复提交机制，可能导致重复创建合同
- **建议**:
  ```javascript
  // 添加防抖处理
  const submitContract = debounce(async (data) => {
    // 提交逻辑
  }, 1000);
  ```

#### 2. 日志未脱敏处理
- **位置**: `src/service/ContractService.java:128`
- **问题**: 日志中打印了完整的客户手机号
- **建议**: 使用脱敏工具类处理敏感信息
  ```java
  log.info("客户手机号: {}", DesensitizationUtil.phone(phone));
  ```

---

### ❌ 严重问题（必须修复）

#### 🔴 1. 敏感信息明文存储
- **位置**: `src/model/Contract.java:23`
- **问题**: 客户身份证号字段未加密存储
- **风险**: 违反数据安全规范，可能导致信息泄露
- **必须修复**:
  ```java
  @Column(name = "id_card")
  @Encrypted  // 添加加密注解
  private String idCard;
  ```

#### 🔴 2. SQL 注入风险
- **位置**: `src/dao/ContractDao.java:67`
- **问题**: 使用字符串拼接构建 SQL 查询
- **风险**: 存在 SQL 注入攻击风险
- **必须修复**:
  ```java
  // 错误写法
  String sql = "SELECT * FROM contract WHERE id = " + contractId;

  // 正确写法
  String sql = "SELECT * FROM contract WHERE id = ?";
  jdbcTemplate.query(sql, new Object[]{contractId}, ...);
  ```

---

### 📊 代码质量评分

| 维度 | 评分 | 说明 |
|------|------|------|
| 业务逻辑 | 8/10 | 流程完整，但缺少部分异常处理 |
| 数据安全 | 5/10 | 存在敏感信息明文存储问题 |
| 接口设计 | 7/10 | 符合 RESTful 规范，缺少限流 |
| 代码质量 | 7/10 | 命名规范，但部分方法过长 |
| 测试覆盖 | 6/10 | 缺少异常场景测试 |

**总体评分**: 6.6/10

---

### 💡 改进建议

#### 短期（1-2 天内必须完成）
1. 🔴 修复敏感信息明文存储问题
2. 🔴 修复 SQL 注入风险
3. 🟡 添加防重复提交机制

#### 中期（1 周内完成）
1. 优化数据库查询性能
2. 补充异常场景测试用例
3. 完善接口文档

#### 长期（持续优化）
1. 提高测试覆盖率到 80% 以上
2. 添加性能监控和告警
3. 优化代码结构，降低复杂度

---

### 🎯 关键提醒
- ⚡ 本次审查发现 **2 个严重问题**，必须在提交前修复
- 📌 建议在本地运行完整的测试用例后再提交
- 🔒 涉及敏感数据的修改，建议安排二次审查

---
